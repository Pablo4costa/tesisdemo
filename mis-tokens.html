<!doctype html>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<main class="container">
<header class="site-header">
<h1>Mi portafolio</h1>
</header>


<div id="userInfo" class="muted small"></div>


<section class="card">
<h3>Tokens por propiedad</h3>
<table id="tabla" class="tokens-table">
<thead><tr><th>Propiedad</th><th>Tokens</th><th>Valor aproximado</th></tr></thead>
<tbody></tbody>
</table>
<div id="loadingMsg" class="muted" style="margin-top: 12px; text-align: center;">‚è≥ Cargando tus tenencias...</div>
</section>


<div class="actions">
<a class="btn" id="btnVolv" href="propiedades.html">Volver</a>
</div>


<footer class="muted small">Demo ‚Äî valores aproximados</footer>
</main>


<script src="js/app.js"></script>
<script src="js/api.js"></script>
<script>
// Get user info from localStorage
const usuario_id = localStorage.getItem('usuario_id');
const nombre = localStorage.getItem('nombre');
const userInfo = document.getElementById('userInfo');
const tbody = document.querySelector('#tabla tbody');
const loadingMsg = document.getElementById('loadingMsg');

// Display user info
if (usuario_id && nombre) {
  userInfo.innerHTML = `üë§ <strong>${escapeHtml(nombre)}</strong> (ID: ${usuario_id})`;
  console.log('[MIS-TOKENS] User info:', nombre, usuario_id);
} else {
  userInfo.innerHTML = 'üë§ Usuario no identificado';
  console.log('[MIS-TOKENS] No user in localStorage');
}

// Fetch holdings from API
async function loadHoldings() {
  if (!usuario_id) {
    loadingMsg.textContent = '‚ö†Ô∏è Por favor inicia sesi√≥n primero en login.html';
    console.log('[MIS-TOKENS] No usuario_id in localStorage');
    return;
  }

  try {
    console.log('[MIS-TOKENS] Fetching holdings for user_id:', usuario_id);
    const holdings = await getHoldings(usuario_id);
    
    loadingMsg.style.display = 'none';
    
    if (!holdings || (Array.isArray(holdings) && holdings.length === 0)) {
      tbody.innerHTML = '<tr><td colspan="3" class="muted">No tienes tenencias a√∫n.</td></tr>';
      console.log('[MIS-TOKENS] No holdings found');
      return;
    }

    // Populate table with holdings (mapping tolerant to API field names)
    if (Array.isArray(holdings)) {
      holdings.forEach(holding => {
        const tr = document.createElement('tr');
        const tokens = Number(holding.tokens ?? holding.cantidad_tokens ?? holding.total_tokens ?? 0);
        const precioUnit = Number(holding.precio_unitario ?? holding.precio_token ?? holding.price_per_token ?? 0);
        const propiedadName = holding.propiedad ?? holding.titulo ?? holding.nombre_propiedad ?? `ID ${holding.propiedad_id ?? ''}`;
        const valor_aproximado = (tokens * (precioUnit || 0)).toLocaleString();
        tr.innerHTML = `
          <td>${escapeHtml(propiedadName)}</td>
          <td>${tokens}</td>
          <td>${valor_aproximado} EUR</td>
        `;
        tbody.appendChild(tr);
      });
      console.log('[MIS-TOKENS] Holdings loaded:', holdings.length, 'items');
    }
  } catch (error) {
    loadingMsg.textContent = '‚ùå Error al cargar tus tenencias. Intenta de nuevo.';
    console.error('[MIS-TOKENS] Failed to load holdings:', error);
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  loadHoldings();
});
</script>