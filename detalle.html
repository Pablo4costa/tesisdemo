<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Detalle propiedad - Housegur</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .prop-detail{max-width:980px;margin:18px auto;} /* antes 720px */
    .prop-main{
      width:100%;
      height:clamp(360px, 50vh, 520px); /* más grande y responsivo */
      object-fit:cover;border-radius:8px;display:block;
    }
    .prop-thumbs{display:flex;gap:10px;margin-top:10px;overflow-x:auto;}
    .prop-thumb{width:96px;height:72px;object-fit:cover;border-radius:6px;cursor:pointer;opacity:0.9;border:2px solid transparent;flex:0 0 auto;}
    .prop-thumb.active{opacity:1;border-color:#007bff;}
    .carousel-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.45);color:#fff;border-radius:4px;padding:6px 8px;cursor:pointer;font-weight:700;}
    .carousel-prev{left:12px;}
    .carousel-next{right:12px;}
    .media-wrap{position:relative;}
    .controls-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px;}

    /* Mantener la misma proporción que en propiedades: left + aside 360 + gap 18 dentro de 980 */
    .detail-left{flex:1;max-width:calc(980px - 360px - 18px);}
    @media (max-width:980px){
      .detail-left{max-width:100%;}
      .prop-main{height:clamp(280px, 42vh, 420px);}
      .prop-thumb{width:84px;height:64px;}
    }

    /* NUEVO: descripción y tabla compacta */
    .prop-about{margin-top:16px;}
    .prop-about h3{margin:12px 0 8px;color:var(--accent);}
    .small-info{width:100%;max-width:520px;border-collapse:collapse;border-spacing:0;}
    .small-info th,.small-info td{padding:8px 10px;border-bottom:1px solid #e6e6e6;text-align:left;}
    .small-info th{width:45%;color:#374151;font-weight:600;background:#f9fafb;}
    .small-info td{color:#111;}

    /* nuevo: header con logo y textos */
.site-header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.site-logo{width:88px;height:auto;object-fit:contain;}
.header-text{display:flex;flex-direction:column;}
.header-title{font-size:24px;margin:0;color:#111;}
.header-sub{
  font-size:19px;        /* antes 14px */
  font-weight:700;       /* negrita */
  color:var(--accent);         /* más intenso (puedes usar var(--accent) si prefieres) */
  margin:6px 0 0;
}

/* Propiedades header */
.site-header-Propiedades{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* izquierda */
  gap:16px;
  margin-bottom:24px;
}
.site-logo-propiedades{
  width:72px;
  height:auto;
  object-fit:contain;
  flex:0 0 72px;
}
.site-header-Propiedades .header-text{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}
.site-header-Propiedades h1{
  margin:0;
  font-size:1.8rem;
  color:var(--accent);
}
.site-header-Propiedades .subtitle{
  margin:4px 0 0;
  color:var(--muted);
  font-size:0.95rem;
}
  </style>
</head>
<body>
<main class="container prop-detail">

  <header class="site-header-Propiedades">
  <img src="img/logoChiquito.png" alt="Housegur" class="site-logo-propiedades">
  <div class="header-text">
    <h1>HOUSEGUR</h1>
    <p class="subtitle muted">Plataforma de inversión tokenizada</p>
  </div>
</header>

  <a class="btn" href="propiedades.html">← Volver al listado</a>

  <div style="display:flex;gap:18px;align-items:flex-start;">
    <div class="detail-left">
      <div id="detalle"></div>
    </div>
    <aside style="width:360px;flex:0 0 360px;position:sticky;top:18px;" id="chatAside">
      <!-- partial del chat se cargará aquí -->
    </aside>
  </div>
</main>

<script src="js/app.js"></script>
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/navigation.js"></script>
<script src="js/chat.js"></script>
<script>
function getParamRaw(name){ return new URLSearchParams(location.search).get(name); }

// Render detail page using the live API. This avoids demo mocks.
async function renderDetalle(){
  const detalle = document.getElementById('detalle');
  if (!detalle) return;

  const propId = parseInt(getParamRaw('propiedad'),10);
  try {
    // Fetch properties from API and find the requested one
    const props = await getProperties();
    // store globally for chat usage
    window.propiedadesLoaded = Array.isArray(props) ? props : [];

    const prop = window.propiedadesLoaded.find(p => Number(p.id) === Number(propId));
    if (!prop) {
      detalle.innerHTML = `<p class="muted">Propiedad no encontrada.</p>`;
      return;
    }

    const fotos = Array.isArray(prop.fotos) && prop.fotos.length
      ? prop.fotos
      : (prop.url ? [prop.url] : ['img/placeholder.png']);
    const pricePerToken = Number(prop.precio_token ?? prop.precio ?? 0);
    const rentObj = prop.rentabilidad_objetivo ?? prop.rentabilidad ?? '';

    // NUEVO: datos para la descripción y tabla
    const pick = (obj, ...keys) => {
      for (const k of keys) {
        if (obj && obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];
      }
      return '';
    };
    const yn = (v) => {
      if (v === '' || v === null || v === undefined) return '-';
      const s = String(v).toLowerCase();
      return (s === 'false' || s === 'no' || s === '0' || v === 0) ? 'No' : 'Sí';
    };

    const desc = pick(prop, 'descripcion','descripcion_larga','descripcion_corta','descripción','descripción_larga') || 'Sin descripción disponible.';
    const superficie = pick(prop, 'm2','superficie','superficie_m2');
    const habitaciones = pick(prop, 'habitaciones','dormitorios','rooms');
    const banos = pick(prop, 'banos','baños','bathrooms');
    const terrazaVal = pick(prop, 'terraza','tiene_terraza','con_terraza');
    const piscinaVal = pick(prop, 'piscina','tiene_piscina','con_piscina');

    detalle.innerHTML = `
      <h2>${escapeHtml(prop.titulo || 'Propiedad')}</h2>
      <p class="muted">${escapeHtml(prop.ciudad || '')} • ${escapeHtml(prop.tipo || '')} • ${prop.m2 || ''} m²</p>
      <div class="media-wrap">
        <img src="${fotos[0]}" class="prop-main" id="mainImg" data-index="0" alt="${escapeHtml(prop.titulo || '')}">
        <div class="carousel-nav carousel-prev" id="prevBtn">&lt;</div>
        <div class="carousel-nav carousel-next" id="nextBtn">&gt;</div>
      </div>
      <div class="prop-thumbs" id="thumbs">
        ${fotos.map((f,i)=>`<img src="${f}" class="prop-thumb${i===0?' active':''}" data-index="${i}" alt="thumb ${i+1}">`).join('')}
      </div>
      <div class="controls-row">
        <div>Precio por token: <strong>${pricePerToken || ''} EUR</strong></div>
        <label><input type="checkbox" id="autoplay" checked> Autoplay</label>
      </div>
      <p style="margin-top:12px;">Rentabilidad objetivo: <strong>${rentObj}</strong></p>

      <!-- NUEVO: Descripción + tabla de datos -->
      <section class="prop-about">
        <h3>Descripción</h3>
        <p>${escapeHtml(desc).replace(/\n/g,'<br>')}</p>
        <table class="small-info" aria-label="Información de la propiedad">
          <tbody>
            <tr>
              <th scope="row">Superficie</th>
              <td>${superficie ? `${superficie} m²` : '-'}</td>
            </tr>
            <tr>
              <th scope="row">Habitaciones</th>
              <td>${habitaciones || '-'}</td>
            </tr>
            <tr>
              <th scope="row">Baños</th>
              <td>${banos || '-'}</td>
            </tr>
            <tr>
              <th scope="row">Terraza</th>
              <td>${yn(terrazaVal)}</td>
            </tr>
            <tr>
              <th scope="row">Piscina</th>
              <td>${yn(piscinaVal)}</td>
            </tr>
          </tbody>
        </table>
      </section>
    `;

    // behavior carousel
    const mainImg = document.getElementById('mainImg');
    const thumbs = Array.from(document.querySelectorAll('.prop-thumb'));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const autoplayToggle = document.getElementById('autoplay');

    function showIndex(i){
      const idx = (i + thumbs.length) % thumbs.length;
      mainImg.src = thumbs[idx].src;
      mainImg.dataset.index = idx;
      thumbs.forEach(t=>t.classList.remove('active'));
      thumbs[idx].classList.add('active');
    }

    thumbs.forEach(t => t.addEventListener('click', ()=> showIndex(parseInt(t.dataset.index,10))));
    prevBtn && prevBtn.addEventListener('click', ()=> showIndex(parseInt(mainImg.dataset.index,10)-1));
    nextBtn && nextBtn.addEventListener('click', ()=> showIndex(parseInt(mainImg.dataset.index,10)+1));

    // autoplay
    let timer = null;
    const INTERVAL = 3000;
    function startAuto(){ if(timer) return; timer = setInterval(()=> nextBtn.click(), INTERVAL); }
    function stopAuto(){ if(!timer) return; clearInterval(timer); timer = null; }
    if (autoplayToggle.checked) startAuto();
    autoplayToggle.addEventListener('change', ()=> autoplayToggle.checked ? startAuto() : stopAuto());
    const mediaWrap = document.querySelector('.media-wrap');
    mediaWrap && mediaWrap.addEventListener('mouseenter', stopAuto);
    mediaWrap && mediaWrap.addEventListener('mouseleave', ()=> { if(autoplayToggle.checked) startAuto(); });

  } catch (err) {
    console.error('[DETALLE] Failed to load property from API', err);
    detalle.innerHTML = `<p class="muted">Error cargando la propiedad.</p>`;
  }
}

/* small escape helper (re-use from propiedades if available) */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* Cargar partial del chat y inicializarlo (fetch con fallback) */
async function initChatPartialAndChat(){
  const aside = document.getElementById('chatAside');
  try {
    const resp = await fetch(new URL('partials/chat.html', location.href).href);
    aside.innerHTML = resp.ok ? await resp.text() : '<div id="globalChatContainer"></div>';
  } catch(e){
    aside.innerHTML = '<div id="globalChatContainer"></div>';
  }

  if (typeof initGlobalChat === 'function') {
    const usuario = getParamRaw('usuario') || 'Invitado';
    // Get chat webhook from centralized config (js/config.js)
    const CHAT_WEBHOOK = window.CONFIG?.CHAT_WEBHOOK || 'https://palasino.app.n8n.cloud/webhook/housegur-chat';
    const propsForChat = window.propiedadesLoaded || [];
    initGlobalChat('globalChatContainer', { user: usuario, props: propsForChat, webhookUrl: CHAT_WEBHOOK });
    // enviar pregunta pendiente si existe
    const pending = sessionStorage.getItem('housegur.pendingQuestion');
    if (pending && window.__housegur_chat && typeof window.__housegur_chat.sendMessage === 'function') {
      window.__housegur_chat.sendMessage(pending);
      sessionStorage.removeItem('housegur.pendingQuestion');
    }
  } else {
    console.warn('initGlobalChat no disponible (asegúrate de cargar js/chat.js antes de este script)');
  }
}

/* Init cuando DOM listo */
document.addEventListener('DOMContentLoaded', async () => {
  renderDetalle();
  await initChatPartialAndChat();
});
</script>
</body>
</html>