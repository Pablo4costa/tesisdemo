<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Detalle propiedad - Housegur</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
.prop-detail{max-width:720px;margin:18px auto;}
.prop-main{width:100%;height:360px;object-fit:cover;border-radius:8px;display:block;}
.prop-thumbs{display:flex;gap:8px;margin-top:8px;overflow-x:auto;}
.prop-thumb{width:72px;height:54px;object-fit:cover;border-radius:6px;cursor:pointer;opacity:0.85;border:2px solid transparent;flex:0 0 auto;}
.prop-thumb.active{opacity:1;border-color:#007bff;}
.carousel-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.45);color:#fff;border-radius:4px;padding:6px 8px;cursor:pointer;font-weight:700;}
.carousel-prev{left:12px;}
.carousel-next{right:12px;}
.media-wrap{position:relative;}
.controls-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
  </style>
</head>
<body>
<main class="container prop-detail">
  <a class="btn" href="propiedades.html">← Volver al listado</a>

  <div style="display:flex;gap:18px;align-items:flex-start;">
    <div style="flex:1;">
      <div id="detalle"></div>
    </div>
    <aside style="width:360px;flex:0 0 360px;position:sticky;top:18px;" id="chatAside">
      <!-- partial del chat se cargará aquí -->
    </aside>
  </div>
</main>

<script src="js/app.js"></script>
<script src="js/chat.js"></script>
<script>
/* datos mínimos (si tu app ya define propsMock en otro sitio, elimina esta definición duplicada) */
const propsMock = [
  {id:1, ciudad:'Alicante', tipo:'Departamento', titulo:'Loft frente al mar', m2:85, rentabilidad:7.5, precio:100, tokens_disponibles:10000, tokens_total:12000, fecha:'2025-10-20', fotos:['img/alicante-loft-1.jpg','img/alicante-loft-2.jpg']},
  {id:2, ciudad:'Madrid', tipo:'Local comercial', titulo:'Local en zona céntrica', m2:120, rentabilidad:8.2, precio:150, tokens_disponibles:5000, tokens_total:8000, fecha:'2025-11-02', fotos:['img/madrid-local-1.jpg','img/madrid-local-2.jpg']},
  {id:3, ciudad:'Barcelona', tipo:'Casa', titulo:'Casa familiar con jardín', m2:200, rentabilidad:6.0, precio:200, tokens_disponibles:2000, tokens_total:3000, fecha:'2025-09-30', fotos:['img/barcelona-casa-1.jpg','img/barcelona-casa-2.jpg','img/barcelona-casa-3.jpg']}
];

function getParamRaw(name){ return new URLSearchParams(location.search).get(name); }

function renderDetalle(){
  const propId = parseInt(getParamRaw('propiedad'),10) || propsMock[0].id;
  const prop = propsMock.find(p => p.id === propId) || propsMock[0];
  const detalle = document.getElementById('detalle');
  if (!detalle) return;
  const fotos = (prop.fotos && prop.fotos.length) ? prop.fotos : ['img/placeholder.png'];
  detalle.innerHTML = `
    <h2>${escapeHtml(prop.titulo)}</h2>
    <p class="muted">${prop.ciudad} • ${prop.tipo} • ${prop.m2} m²</p>
    <div class="media-wrap">
      <img src="${fotos[0]}" class="prop-main" id="mainImg" data-index="0" alt="${escapeHtml(prop.titulo)}">
      <div class="carousel-nav carousel-prev" id="prevBtn">&lt;</div>
      <div class="carousel-nav carousel-next" id="nextBtn">&gt;</div>
    </div>
    <div class="prop-thumbs" id="thumbs">
      ${fotos.map((f,i)=>`<img src="${f}" class="prop-thumb${i===0?' active':''}" data-index="${i}" alt="thumb ${i+1}">`).join('')}
    </div>
    <div class="controls-row">
      <div>Precio por token: <strong>${prop.precio} EUR</strong></div>
      <label><input type="checkbox" id="autoplay" checked> Autoplay</label>
    </div>
    <p style="margin-top:12px;">Rentabilidad objetivo: <strong>${prop.rentabilidad}%</strong></p>
  `;

  // behavior carousel
  const mainImg = document.getElementById('mainImg');
  const thumbs = Array.from(document.querySelectorAll('.prop-thumb'));
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const autoplayToggle = document.getElementById('autoplay');

  function showIndex(i){
    const idx = (i + thumbs.length) % thumbs.length;
    mainImg.src = thumbs[idx].src;
    mainImg.dataset.index = idx;
    thumbs.forEach(t=>t.classList.remove('active'));
    thumbs[idx].classList.add('active');
  }

  thumbs.forEach(t => t.addEventListener('click', ()=> showIndex(parseInt(t.dataset.index,10))));
  prevBtn && prevBtn.addEventListener('click', ()=> showIndex(parseInt(mainImg.dataset.index,10)-1));
  nextBtn && nextBtn.addEventListener('click', ()=> showIndex(parseInt(mainImg.dataset.index,10)+1));

  // autoplay
  let timer = null;
  const INTERVAL = 3000;
  function startAuto(){ if(timer) return; timer = setInterval(()=> nextBtn.click(), INTERVAL); }
  function stopAuto(){ if(!timer) return; clearInterval(timer); timer = null; }
  if (autoplayToggle.checked) startAuto();
  autoplayToggle.addEventListener('change', ()=> autoplayToggle.checked ? startAuto() : stopAuto());
  const mediaWrap = document.querySelector('.media-wrap');
  mediaWrap && mediaWrap.addEventListener('mouseenter', stopAuto);
  mediaWrap && mediaWrap.addEventListener('mouseleave', ()=> { if(autoplayToggle.checked) startAuto(); });
}

/* small escape helper (re-use from propiedades if available) */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* Cargar partial del chat y inicializarlo (fetch con fallback) */
async function initChatPartialAndChat(){
  const aside = document.getElementById('chatAside');
  try {
    const resp = await fetch(new URL('partials/chat.html', location.href).href);
    aside.innerHTML = resp.ok ? await resp.text() : '<div id="globalChatContainer"></div>';
  } catch(e){
    aside.innerHTML = '<div id="globalChatContainer"></div>';
  }

  if (typeof initGlobalChat === 'function') {
    const usuario = getParamRaw('usuario') || 'Invitado';
    initGlobalChat('globalChatContainer', { user: usuario, props: propsMock });
    // enviar pregunta pendiente si existe
    const pending = sessionStorage.getItem('housegur.pendingQuestion');
    if (pending && window.__housegur_chat && typeof window.__housegur_chat.sendMessage === 'function') {
      window.__housegur_chat.sendMessage(pending);
      sessionStorage.removeItem('housegur.pendingQuestion');
    }
  } else {
    console.warn('initGlobalChat no disponible (asegúrate de cargar js/chat.js antes de este script)');
  }
}

/* Init cuando DOM listo */
document.addEventListener('DOMContentLoaded', async () => {
  renderDetalle();
  await initChatPartialAndChat();
});
</script>
</body>
</html>