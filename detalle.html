<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Detalle propiedad - Housegur</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
.prop-detail{max-width:720px;margin:18px auto;}
.prop-main{width:100%;height:360px;object-fit:cover;border-radius:8px;display:block;}
.prop-thumbs{display:flex;gap:8px;margin-top:8px;overflow-x:auto;}
.prop-thumb{width:72px;height:54px;object-fit:cover;border-radius:6px;cursor:pointer;opacity:0.85;border:2px solid transparent;flex:0 0 auto;}
.prop-thumb.active{opacity:1;border-color:#007bff;}
.carousel-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.45);color:#fff;border-radius:4px;padding:6px 8px;cursor:pointer;font-weight:700;}
.carousel-prev{left:12px;}
.carousel-next{right:12px;}
.media-wrap{position:relative;}
.controls-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px;}
  </style>
</head>
<body>
<main class="container prop-detail">
  <a class="btn" href="propiedades.html">← Volver al listado</a>

  <div style="display:flex;gap:18px;align-items:flex-start;">
    <div style="flex:1;">
      <div id="detalle"></div>
    </div>
    <aside style="width:360px;flex:0 0 360px;position:sticky;top:18px;" id="chatAside">
      <!-- partial del chat se cargará aquí -->
    </aside>
  </div>
</main>

<script src="js/app.js"></script>
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/chat.js"></script>
<script>
function getParamRaw(name){ return new URLSearchParams(location.search).get(name); }

// Render detail page using the live API. This avoids demo mocks.
async function renderDetalle(){
  const detalle = document.getElementById('detalle');
  if (!detalle) return;

  const propId = parseInt(getParamRaw('propiedad'),10);
  try {
    // Fetch properties from API and find the requested one
    const props = await getProperties();
    // store globally for chat usage
    window.propiedadesLoaded = Array.isArray(props) ? props : [];

    const prop = window.propiedadesLoaded.find(p => Number(p.id) === Number(propId));
    if (!prop) {
      detalle.innerHTML = `<p class="muted">Propiedad no encontrada.</p>`;
      return;
    }

    const fotos = (prop.fotos && prop.fotos.length) ? prop.fotos : ['img/placeholder.png'];
    detalle.innerHTML = `
      <h2>${escapeHtml(prop.titulo || 'Propiedad')}</h2>
      <p class="muted">${escapeHtml(prop.ciudad || '')} • ${escapeHtml(prop.tipo || '')} • ${prop.m2 || ''} m²</p>
      <div class="media-wrap">
        <img src="${fotos[0]}" class="prop-main" id="mainImg" data-index="0" alt="${escapeHtml(prop.titulo || '')}">
        <div class="carousel-nav carousel-prev" id="prevBtn">&lt;</div>
        <div class="carousel-nav carousel-next" id="nextBtn">&gt;</div>
      </div>
      <div class="prop-thumbs" id="thumbs">
        ${fotos.map((f,i)=>`<img src="${f}" class="prop-thumb${i===0?' active':''}" data-index="${i}" alt="thumb ${i+1}">`).join('')}
      </div>
      <div class="controls-row">
        <div>Precio por token: <strong>${prop.precio || ''} EUR</strong></div>
        <label><input type="checkbox" id="autoplay" checked> Autoplay</label>
      </div>
      <p style="margin-top:12px;">Rentabilidad objetivo: <strong>${prop.rentabilidad || ''}%</strong></p>
    `;

    // behavior carousel
    const mainImg = document.getElementById('mainImg');
    const thumbs = Array.from(document.querySelectorAll('.prop-thumb'));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const autoplayToggle = document.getElementById('autoplay');

    function showIndex(i){
      const idx = (i + thumbs.length) % thumbs.length;
      mainImg.src = thumbs[idx].src;
      mainImg.dataset.index = idx;
      thumbs.forEach(t=>t.classList.remove('active'));
      thumbs[idx].classList.add('active');
    }

    thumbs.forEach(t => t.addEventListener('click', ()=> showIndex(parseInt(t.dataset.index,10))));
    prevBtn && prevBtn.addEventListener('click', ()=> showIndex(parseInt(mainImg.dataset.index,10)-1));
    nextBtn && nextBtn.addEventListener('click', ()=> showIndex(parseInt(mainImg.dataset.index,10)+1));

    // autoplay
    let timer = null;
    const INTERVAL = 3000;
    function startAuto(){ if(timer) return; timer = setInterval(()=> nextBtn.click(), INTERVAL); }
    function stopAuto(){ if(!timer) return; clearInterval(timer); timer = null; }
    if (autoplayToggle.checked) startAuto();
    autoplayToggle.addEventListener('change', ()=> autoplayToggle.checked ? startAuto() : stopAuto());
    const mediaWrap = document.querySelector('.media-wrap');
    mediaWrap && mediaWrap.addEventListener('mouseenter', stopAuto);
    mediaWrap && mediaWrap.addEventListener('mouseleave', ()=> { if(autoplayToggle.checked) startAuto(); });

  } catch (err) {
    console.error('[DETALLE] Failed to load property from API', err);
    detalle.innerHTML = `<p class="muted">Error cargando la propiedad.</p>`;
  }
}

/* small escape helper (re-use from propiedades if available) */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* Cargar partial del chat y inicializarlo (fetch con fallback) */
async function initChatPartialAndChat(){
  const aside = document.getElementById('chatAside');
  try {
    const resp = await fetch(new URL('partials/chat.html', location.href).href);
    aside.innerHTML = resp.ok ? await resp.text() : '<div id="globalChatContainer"></div>';
  } catch(e){
    aside.innerHTML = '<div id="globalChatContainer"></div>';
  }

  if (typeof initGlobalChat === 'function') {
    const usuario = getParamRaw('usuario') || 'Invitado';
    // Get chat webhook from centralized config (js/config.js)
    const CHAT_WEBHOOK = window.CONFIG?.CHAT_WEBHOOK || 'https://palasino.app.n8n.cloud/webhook/housegur-chat';
    const propsForChat = window.propiedadesLoaded || [];
    initGlobalChat('globalChatContainer', { user: usuario, props: propsForChat, webhookUrl: CHAT_WEBHOOK });
    // enviar pregunta pendiente si existe
    const pending = sessionStorage.getItem('housegur.pendingQuestion');
    if (pending && window.__housegur_chat && typeof window.__housegur_chat.sendMessage === 'function') {
      window.__housegur_chat.sendMessage(pending);
      sessionStorage.removeItem('housegur.pendingQuestion');
    }
  } else {
    console.warn('initGlobalChat no disponible (asegúrate de cargar js/chat.js antes de este script)');
  }
}

/* Init cuando DOM listo */
document.addEventListener('DOMContentLoaded', async () => {
  renderDetalle();
  await initChatPartialAndChat();
});
</script>
</body>
</html>