<!doctype html>
<title>Propiedades - Housegur</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* layout: listado + asistente */
.page-split{display:flex;gap:18px;align-items:flex-start;}
.left-col{flex:1;min-width:320px;max-width:900px;}
.right-col{width:360px;flex:0 0 360px;position:sticky;top:18px;height:80vh;align-self:flex-start}

/* responsive: apilar en pantallas pequeñas */
@media (max-width:980px){
  .page-split{flex-direction:column;}
  .right-col{width:100%;position:relative;height:auto;}
}

/* filtros y tarjetas (mantener estilos previos) */
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.filter-bar label{font-size:13px;color:#444;}
.prop-media{margin-bottom:8px;}
.prop-main{width:100%;height:160px;object-fit:cover;border-radius:6px;display:block;}
.card.prop{padding:12px;}
.small-input{width:100px;padding:6px;border-radius:4px;border:1px solid #ddd;}
.select-input{padding:6px;border-radius:4px;border:1px solid #ddd;}

/* progreso tokens vendidos */
.prop-progress{margin-top:8px;background:#eee;border-radius:6px;height:10px;overflow:hidden;}
.prop-progress-bar{height:100%;background:#0b7cff;width:0%;transition:width .4s ease;}
.prop-percent{font-size:12px;color:#333;margin-top:6px;}

/* asistente: tarjeta y chat */
.chat-card{background:#fff;border:1px solid #e6e6e6;border-radius:8px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,0.04);height:100%;display:flex;flex-direction:column;}
.chat-header{display:flex;align-items:center;gap:10px;border-bottom:1px solid #f0f0f0;padding-bottom:10px;margin-bottom:10px;}
.chat-title{font-weight:700;}
.chat-body{flex:1;overflow:auto;padding-right:6px;}
.msg{display:flex;gap:8px;margin-bottom:10px;align-items:flex-start;}
.msg .bubble{max-width:78%;padding:8px 10px;border-radius:12px;font-size:14px;line-height:1.3;}
.msg.user{justify-content:flex-end;}
.msg.user .bubble{background:#0b7cff;color:#fff;border-bottom-right-radius:4px;border-bottom-left-radius:12px;border-top-left-radius:12px;border-top-right-radius:12px;}
.msg.assistant .bubble{background:#f3f5fb;color:#111;border-bottom-left-radius:4px;}
.msg .meta{font-size:11px;color:#666;margin-top:4px;}
.chat-input-row{display:flex;gap:8px;margin-top:8px;border-top:1px solid #f0f0f0;padding-top:8px;}
.chat-input{flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px;}
.chat-send{padding:8px 12px;border-radius:6px;border:none;background:#0b7cff;color:#fff;cursor:pointer;}
.chat-muted{font-size:12px;color:#666;margin-top:8px;text-align:center;}
.loading-dot{display:inline-block;width:8px;height:8px;background:#bbb;border-radius:50%;margin-right:4px;animation:blink 1s infinite;}
@keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}

/* nuevo: header con logo y textos */
.site-header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.site-logo{width:88px;height:auto;object-fit:contain;}
.header-text{display:flex;flex-direction:column;}
.header-title{font-size:24px;margin:0;color:#111;}
.header-sub{font-size:14px;color:#555;margin:6px 0 0;}
</style>
</head>
<body>
<main class="container">
<header class="site-header">
  <img src="img/logo.png" alt="Housegur" class="site-logo">
  <div class="header-text">
    <h1 class="header-title">Propiedades Tokenizadas</h1>
    <p class="header-sub">Invierte en fracciones de propiedades premium desde 100€. Tu asesor personal te guiará en cada paso.</p>
  </div>
</header>

<div id="userBar" class="muted small"></div>

<div class="page-split">
  <!-- columna izquierda: filtros + listado -->
  <div class="left-col">
    <!-- filtros -->
    <div class="filter-bar" id="filters">
      <label>Ubicación:
        <select id="filterCiudad" class="select-input"><option value="">Todas</option></select>
      </label>
      <label>Precio token (EUR):
        <input id="minPrecio" class="small-input" type="number" placeholder="mín" min="0">
        <input id="maxPrecio" class="small-input" type="number" placeholder="máx" min="0">
      </label>
      <label>Orden:
        <select id="sortBy" class="select-input">
          <option value="reciente">Más recientes</option>
          <option value="precioAsc">Precio ↑</option>
          <option value="precioDesc">Precio ↓</option>
        </select>
      </label>
      <button id="btnLimpiar" class="btn">Limpiar</button>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>

    <div class="actions" style="margin-top:12px;">
      <a class="btn" id="btnMisTokens">Ver mis tokens</a>
      <a class="btn" href="index.html">Volver</a>
    </div>

    <footer class="muted small" style="margin-top:10px;">Datos mock para demo</footer>
  </div>

  <!-- columna derecha: asistente virtual -->
  <aside class="right-col" id="chatAside">
    <!-- el partial se cargará aquí -->
  </aside>
</div>

</main>

<script src="js/app.js"></script>
<script src="js/chat.js"></script>
<script>
/* --- listado y filtros (definiciones completas) */
const propsMock = [
  {id:1, ciudad:'Alicante', tipo:'Departamento', titulo:'Loft frente al mar', m2:85, rentabilidad:7.5, precio:100, tokens_disponibles:10000, tokens_total:12000, fecha:'2025-10-20', fotos:['img/alicante-loft-1.jpg','img/al.jpg']},
  {id:2, ciudad:'Madrid', tipo:'Local comercial', titulo:'Local en zona céntrica', m2:120, rentabilidad:8.2, precio:150, tokens_disponibles:5000, tokens_total:8000, fecha:'2025-11-02', fotos:['img/madrid.jpg','img/propmadrid.jpg']},
  {id:3, ciudad:'Barcelona', tipo:'Casa', titulo:'Casa familiar con jardín', m2:200, rentabilidad:6.0, precio:200, tokens_disponibles:2000, tokens_total:3000, fecha:'2025-09-30', fotos:['img/valencia.jpg','img/val.jpg','img/hero.jpg']}
];

const STORAGE_KEY = 'propiedades.filters';
const grid = document.getElementById('grid');
const filterCiudad = document.getElementById('filterCiudad');
const minPrecio = document.getElementById('minPrecio');
const maxPrecio = document.getElementById('maxPrecio');
const sortBy = document.getElementById('sortBy');
const btnLimpiar = document.getElementById('btnLimpiar');

function getParam(name){ try { return new URLSearchParams(location.search).get(name); } catch(e){ return null; } }

function populateCiudadOptions(){
  if (!filterCiudad) return;
  filterCiudad.innerHTML = '<option value="">Todas</option>';
  const ciudades = Array.from(new Set(propsMock.map(p=>p.ciudad))).sort();
  ciudades.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    filterCiudad.appendChild(opt);
  });
}

function saveFilters(){
  const state = { ciudad: filterCiudad.value || '', min: minPrecio.value || '', max: maxPrecio.value || '', sort: sortBy.value || 'reciente' };
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){ }
}

function loadFilters(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const state = JSON.parse(raw);
    if (state.ciudad) {
      const optExists = Array.from(filterCiudad.options).some(o => o.value === state.ciudad);
      if (optExists) filterCiudad.value = state.ciudad;
    }
    if (state.min !== undefined) minPrecio.value = state.min;
    if (state.max !== undefined) maxPrecio.value = state.max;
    if (state.sort) sortBy.value = state.sort;
  } catch(e){ }
}

function applyFiltersAndRender(){
  let list = propsMock.slice();
  const ciudadVal = filterCiudad.value;
  if (ciudadVal) list = list.filter(p=>p.ciudad === ciudadVal);

  const min = parseFloat(minPrecio.value);
  const max = parseFloat(maxPrecio.value);
  if (!isNaN(min)) list = list.filter(p=>p.precio >= min);
  if (!isNaN(max)) list = list.filter(p=>p.precio <= max);

  switch(sortBy.value){
    case 'reciente': list.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha)); break;
    case 'precioAsc': list.sort((a,b)=> a.precio - b.precio); break;
    case 'precioDesc': list.sort((a,b)=> b.precio - a.precio); break;
  }

  renderList(list);
}

function renderList(list){
  if (!grid) return;
  grid.innerHTML = '';
  if(!list.length){
    grid.innerHTML = '<p class="muted">No se encontraron propiedades con esos filtros.</p>';
    return;
  }
  list.forEach(p => {
    const foto = (p.fotos && p.fotos.length) ? p.fotos[0] : 'img/placeholder.png';
    const total = Number(p.tokens_total) || 0;
    const available = Number(p.tokens_disponibles) || 0;
    const soldPercent = total > 0 ? ((total - available) / total) * 100 : 0;
    const soldLabel = total > 0 ? `${soldPercent.toFixed(1)}% vendidos` : 'Sin datos';
    const progressWidth = Math.max(0, Math.min(100, soldPercent));
    const el = document.createElement('article');
    el.className = 'card prop';
    el.innerHTML = `
      <div class="prop-media">
        <img src="${foto}" alt="${escapeHtml(p.titulo)}" class="prop-main">
      </div>
      <h3>${escapeHtml(p.titulo)}</h3>
      <p class="muted">${p.ciudad} • ${p.tipo} • ${p.m2} m²</p>
      <p>Precio por token: <strong>${p.precio} EUR</strong></p>
      <div class="prop-progress" aria-hidden="true">
        <div class="prop-progress-bar" style="width:${progressWidth}%"></div>
      </div>
      <div class="prop-percent">${soldLabel} — ${available.toLocaleString()} tokens disponibles</div>
      <div class="card-actions" style="margin-top:8px;">
        <a class="btn small" href="detalle.html?usuario=${encodeURIComponent(getParam('usuario')||'Invitado')}&propiedad=${p.id}">Ver detalle</a>
        <button class="btn small" data-prop="${p.id}" data-action="ask">Preguntar sobre esta</button>
      </div>
    `;
    grid.appendChild(el);
  });
}

/* helpers for escaping */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* eventos */
if (filterCiudad && minPrecio && maxPrecio && sortBy) {
  [filterCiudad, minPrecio, maxPrecio, sortBy].forEach(el => el.addEventListener('change', () => { saveFilters(); applyFiltersAndRender(); }));
}
if (btnLimpiar) {
  btnLimpiar.addEventListener('click', () => {
    filterCiudad.value = '';
    minPrecio.value = '';
    maxPrecio.value = '';
    sortBy.value = 'reciente';
    try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
    applyFiltersAndRender();
  });
}

/* escuchar botón "Preguntar sobre esta" desde la grid */
grid.addEventListener && grid.addEventListener('click', (e) => {
  const btn = e.target.closest && e.target.closest('button[data-action="ask"]');
  if (!btn) return;
  const propId = Number(btn.dataset.prop);
  const prop = propsMock.find(p=>p.id===propId);
  if (!prop) return;
  const q = `Dime detalles de la propiedad "${prop.titulo}" en ${prop.ciudad}.`;
  // if chat already initialized, put question in input
  if (window.__housegur_chat && typeof window.__housegur_chat.append === 'function') {
    window.__housegur_chat.sendMessage(q);
  } else {
    // fallback: save to session and open chat later
    sessionStorage.setItem('housegur.pendingQuestion', q);
    const chatCont = document.getElementById('globalChatContainer');
    if (chatCont) chatCont.scrollIntoView({behavior:'smooth'});
  }
});

/* --- DOM ready: init UI and chat partial --- */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    populateCiudadOptions();
    loadFilters();
    applyFiltersAndRender();
  } catch(e){ console.warn('init listado failed', e); }

  // cargar partial del chat (fallback si fetch no disponible)
  try {
    const partialUrl = new URL('partials/chat.html', location.href).href;
    const resp = await fetch(partialUrl);
    if (resp.ok) {
      document.getElementById('chatAside').innerHTML = await resp.text();
    } else {
      document.getElementById('chatAside').innerHTML = '<div id="globalChatContainer"></div>';
    }
  } catch(e) {
    document.getElementById('chatAside').innerHTML = '<div id="globalChatContainer"></div>';
  }

  // inicializar chat
  if (typeof initGlobalChat === 'function') {
    const usuario = getParam('usuario') || 'Invitado';
    initGlobalChat('globalChatContainer', { user: usuario, props: propsMock });
    // if there was a pending question set before chat init, send it
    const pendingQ = sessionStorage.getItem('housegur.pendingQuestion');
    if (pendingQ && window.__housegur_chat && typeof window.__housegur_chat.sendMessage === 'function') {
      window.__housegur_chat.sendMessage(pendingQ);
      sessionStorage.removeItem('housegur.pendingQuestion');
    }
  } else {
    console.warn('initGlobalChat no disponible');
  }
});
</script>
</body>
</html>