<!doctype html>
<title>Propiedades - Housegur</title>
<link rel="stylesheet" href="css/style.css">
<style>
/* layout: listado + asistente */
.page-split{display:flex;gap:18px;align-items:flex-start;}
.left-col{flex:1;min-width:320px;max-width:900px;}
.right-col{width:360px;flex:0 0 360px;position:sticky;top:18px;height:80vh;align-self:flex-start}

/* responsive: apilar en pantallas peque√±as */
@media (max-width:980px){
  .page-split{flex-direction:column;}
  .right-col{width:100%;position:relative;height:auto;}
}

/* filtros y tarjetas (mantener estilos previos) */
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.filter-bar label{font-size:13px;color:#444;}
.prop-media{margin-bottom:8px;}
.prop-main{width:100%;height:160px;object-fit:cover;border-radius:6px;display:block;}
.card.prop{padding:12px;}
.small-input{width:100px;padding:6px;border-radius:4px;border:1px solid #ddd;}
.select-input{padding:6px;border-radius:4px;border:1px solid #ddd;}

/* progreso tokens vendidos */
.prop-progress{margin-top:8px;background:#eee;border-radius:6px;height:10px;overflow:hidden;}
.prop-progress-bar{height:100%;background:#0b7cff;width:0%;transition:width .4s ease;}
.prop-percent{font-size:12px;color:#333;margin-top:6px;}

/* asistente: tarjeta y chat */
.chat-card{background:#fff;border:1px solid #e6e6e6;border-radius:8px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,0.04);height:100%;display:flex;flex-direction:column;}
.chat-header{display:flex;align-items:center;gap:10px;border-bottom:1px solid #f0f0f0;padding-bottom:10px;margin-bottom:10px;}
.chat-title{font-weight:700;}
.chat-body{flex:1;overflow:auto;padding-right:6px;}
.msg{display:flex;gap:8px;margin-bottom:10px;align-items:flex-start;}
.msg .bubble{max-width:78%;padding:8px 10px;border-radius:12px;font-size:14px;line-height:1.3;}
.msg.user{justify-content:flex-end;}
.msg.user .bubble{background:#0b7cff;color:#fff;border-bottom-right-radius:4px;border-bottom-left-radius:12px;border-top-left-radius:12px;border-top-right-radius:12px;}
.msg.assistant .bubble{background:#f3f5fb;color:#111;border-bottom-left-radius:4px;}
.msg .meta{font-size:11px;color:#666;margin-top:4px;}
.chat-input-row{display:flex;gap:8px;margin-top:8px;border-top:1px solid #f0f0f0;padding-top:8px;}
.chat-input{flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px;}
.chat-send{padding:8px 12px;border-radius:6px;border:none;background:#0b7cff;color:#fff;cursor:pointer;}
.chat-muted{font-size:12px;color:#666;margin-top:8px;text-align:center;}
.loading-dot{display:inline-block;width:8px;height:8px;background:#bbb;border-radius:50%;margin-right:4px;animation:blink 1s infinite;}
@keyframes blink{0%{opacity:0.2}50%{opacity:1}100%{opacity:0.2}}

/* nuevo: header con logo y textos */
.site-header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
.site-logo{width:88px;height:auto;object-fit:contain;}
.header-text{display:flex;flex-direction:column;}
.header-title{font-size:24px;margin:0;color:#111;}
.header-sub{
  font-size:19px;        /* antes 14px */
  font-weight:700;       /* negrita */
  color:var(--accent);         /* m√°s intenso (puedes usar var(--accent) si prefieres) */
  margin:6px 0 0;
}

/* Propiedades header */
.site-header-Propiedades{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* izquierda */
  gap:16px;
  margin-bottom:24px;
}
.site-logo-propiedades{
  width:72px;
  height:auto;
  object-fit:contain;
  flex:0 0 72px;
}
.site-header-Propiedades .header-text{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}
.site-header-Propiedades h1{
  margin:0;
  font-size:1.8rem;
  color:var(--accent);
}
.site-header-Propiedades .subtitle{
  margin:4px 0 0;
  color:var(--muted);
  font-size:0.95rem;
}

/* user bar m√°s visible y separado del filtro */
#userBar{
  font-size: 1rem;      /* m√°s grande que .small */
  font-weight: 600;     /* resalta el nombre */
  margin: 8px 0 16px;   /* espacio por debajo */
}

/* Toolbar: usuario + acciones a la derecha */
.user-toolbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin: 8px 0 16px; /* separaci√≥n del header y del filtro */
}

/* Reutiliza estilos previos del userBar, pero sin margen interno cuando est√° en toolbar */
.user-toolbar #userBar{
  font-size: 1rem;
  font-weight: 600;
  margin: 0; /* sin margen para alinear con los botones */
}

/* Acciones del usuario en la derecha */
.actions.actions-user{
  display:flex;
  gap:10px;
  margin:0;
}

/* Responsivo: apilar en pantallas peque√±as */
@media (max-width: 768px){
  .user-toolbar{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .actions.actions-user{
    width:100%;
    flex-wrap:wrap;
  }
  .actions.actions-user .btn{
    flex:1 1 auto;
    text-align:center;
  }
}
</style>
</head>
<body>
<main class="container">

<header class="site-header-Propiedades">
  <img src="img/logoChiquito.png" alt="Housegur" class="site-logo-propiedades">
  <div class="header-text">
    <h1>HOUSEGUR</h1>
    <p class="subtitle muted">Plataforma de inversi√≥n tokenizada</p>
  </div>
</header>

<header class="site-header">
  <div class="header-text">
    <p class="header-sub">Invierte en fracciones de propiedades premium desde 100‚Ç¨. Tu asesor personal te guiar√° en cada paso.</p>
  </div>
</header>

<!-- toolbar usuario + botones -->
<div class="user-toolbar">
  <div id="userBar" class="muted"></div>
  <div class="actions actions-user">
    <button id="btnMisTokens" class="btn big-btn">Ver mis tokens</button>
    <a class="btn big-btn" href="index.html">Volver</a>
  </div>
</div>

<div class="page-split">
  <!-- columna izquierda: filtros + listado -->
  <div class="left-col">
    <!-- filtros -->
    <div class="filter-bar" id="filters">
      <label>Ubicaci√≥n:
        <select id="filterCiudad" class="select-input"><option value="">Todas</option></select>
      </label>
      <label>Precio token (EUR):
        <input id="minPrecio" class="small-input" type="number" placeholder="m√≠n" min="0">
        <input id="maxPrecio" class="small-input" type="number" placeholder="m√°x" min="0">
      </label>
      <label>Orden:
        <select id="sortBy" class="select-input">
          <option value="reciente">M√°s recientes</option>
          <option value="precioAsc">Precio ‚Üë</option>
          <option value="precioDesc">Precio ‚Üì</option>
        </select>
      </label>
      <button id="btnLimpiar" class="btn">Limpiar</button>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>

    <footer class="muted small" style="margin-top:10px;">Datos servidos por la API de Housegur</footer>
  </div>

  <!-- columna derecha: asistente virtual -->
  <aside class="right-col" id="chatAside">
    <!-- el partial se cargar√° aqu√≠ -->
  </aside>
</div>

</main>

<script src="js/app.js"></script>
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/chat.js"></script>
<script>
/* --- listado y filtros (definiciones completas) */
// Production: start with empty list and populate from API
let propiedadesActuales = [];
const STORAGE_KEY = 'propiedades.filters';
const grid = document.getElementById('grid');
const filterCiudad = document.getElementById('filterCiudad');
const minPrecio = document.getElementById('minPrecio');
const maxPrecio = document.getElementById('maxPrecio');
const sortBy = document.getElementById('sortBy');
const btnLimpiar = document.getElementById('btnLimpiar');

function getParam(name){ try { return new URLSearchParams(location.search).get(name); } catch(e){ return null; } }

function populateCiudadOptions(){
  if (!filterCiudad) return;
  filterCiudad.innerHTML = '<option value="">Todas</option>';
  const ciudades = Array.from(new Set(propiedadesActuales.map(p=>p.ciudad))).sort();
  ciudades.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    filterCiudad.appendChild(opt);
  });
}

function saveFilters(){
  const state = { ciudad: filterCiudad.value || '', min: minPrecio.value || '', max: maxPrecio.value || '', sort: sortBy.value || 'reciente' };
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){ }
}

function loadFilters(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const state = JSON.parse(raw);
    if (state.ciudad) {
      const optExists = Array.from(filterCiudad.options).some(o => o.value === state.ciudad);
      if (optExists) filterCiudad.value = state.ciudad;
    }
    if (state.min !== undefined) minPrecio.value = state.min;
    if (state.max !== undefined) maxPrecio.value = state.max;
    if (state.sort) sortBy.value = state.sort;
  } catch(e){ }
}

function applyFiltersAndRender(){
  let list = propiedadesActuales.slice();
  const ciudadVal = filterCiudad.value;
  if (ciudadVal) list = list.filter(p=>p.ciudad === ciudadVal);

  const min = parseFloat(minPrecio.value);
  const max = parseFloat(maxPrecio.value);
  if (!isNaN(min)) list = list.filter(p => Number(p.precio_token ?? p.precio ?? 0) >= min);
  if (!isNaN(max)) list = list.filter(p => Number(p.precio_token ?? p.precio ?? 0) <= max);

  switch(sortBy.value){
    case 'reciente': list.sort((a,b)=> new Date(b.fecha_creacion ?? b.fecha ?? 0) - new Date(a.fecha_creacion ?? a.fecha ?? 0)); break;
    case 'precioAsc': list.sort((a,b)=> Number(a.precio_token ?? a.precio ?? 0) - Number(b.precio_token ?? b.precio ?? 0)); break;
    case 'precioDesc': list.sort((a,b)=> Number(b.precio_token ?? b.precio ?? 0) - Number(a.precio_token ?? a.precio ?? 0)); break;
  }

  renderList(list);
}

function renderList(list){
  if (!grid) return;
  grid.innerHTML = '';
  if(!list.length){
    grid.innerHTML = '<p class="muted">No se encontraron propiedades con esos filtros.</p>';
    return;
  }
  list.forEach(p => {
  const foto = (p.fotos && p.fotos.length) ? p.fotos[0] : (p.url ? p.url : 'img/placeholder.png');
  const total = Number(p.total_tokens ?? p.tokens_total ?? 0);
  const available = Number(p.tokens_disponibles ?? 0);
  const soldPercent = total > 0 ? ((total - available) / total) * 100 : 0;
  const soldLabel = total > 0 ? `${soldPercent.toFixed(1)}% vendidos` : 'Sin datos';
  const progressWidth = Math.max(0, Math.min(100, soldPercent));
  const pricePerToken = Number(p.precio_token ?? p.precio ?? 0);
    const el = document.createElement('article');
    el.className = 'card prop';
    el.innerHTML = `
      <div class="prop-media">
        <img src="${foto}" alt="${escapeHtml(p.titulo)}" class="prop-main">
      </div>
      <h3>${escapeHtml(p.titulo)}</h3>
      <p class="muted">${p.ciudad} ‚Ä¢ ${p.tipo} ‚Ä¢ ${p.m2} m¬≤</p>
  <p>Precio por token: <strong>${pricePerToken} EUR</strong></p>
      <div class="prop-progress" aria-hidden="true">
        <div class="prop-progress-bar" style="width:${progressWidth}%"></div>
      </div>
      <div class="prop-percent">${soldLabel} ‚Äî ${available.toLocaleString()} tokens disponibles</div>
      <div class="card-actions" style="margin-top:8px;">
        <a class="btn small" href="detalle.html?propiedad=${p.id}">Ver detalle</a>
  <button class="btn small" data-action="buy" data-prop="${p.id}" data-precio="${pricePerToken}">Comprar tokens</button>
        <button class="btn small" data-prop="${p.id}" data-action="ask">Preguntar sobre esta</button>
      </div>
    `;
    grid.appendChild(el);
  });
}

/* helpers for escaping */
function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* eventos */
if (filterCiudad && minPrecio && maxPrecio && sortBy) {
  [filterCiudad, minPrecio, maxPrecio, sortBy].forEach(el => el.addEventListener('change', () => { saveFilters(); applyFiltersAndRender(); }));
}
if (btnLimpiar) {
  btnLimpiar.addEventListener('click', () => {
    filterCiudad.value = '';
    minPrecio.value = '';
    maxPrecio.value = '';
    sortBy.value = 'reciente';
    try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
    applyFiltersAndRender();
  });
}

/* escuchar botones de la grid (comprar y preguntar) */
grid.addEventListener && grid.addEventListener('click', (e) => {
  // Handle "Comprar tokens" button
  const buyBtn = e.target.closest && e.target.closest('button[data-action="buy"]');
  if (buyBtn) {
    const propId = Number(buyBtn.dataset.prop);
    const precio = Number(buyBtn.dataset.precio);
    const prop = propiedadesActuales.find(p=>p.id===propId);
    if (!prop) {
      console.warn('[PROPIEDADES] Property not found:', propId);
      return;
    }
    console.log('[PROPIEDADES] Buy button clicked for property:', prop.titulo);
    // Redirect to confirm page with buy action
    const usuario_id = localStorage.getItem('usuario_id');
    const url = new URL(window.location.origin + '/confirm.html');
    url.searchParams.set('action', 'buy');
    url.searchParams.set('property_id', propId);
    url.searchParams.set('property_title', prop.titulo);
    url.searchParams.set('price_per_token', precio);
    window.location.href = url.toString();
    return;
  }

  // Handle "Preguntar sobre esta" button
  const btn = e.target.closest && e.target.closest('button[data-action="ask"]');
  if (!btn) return;
  const propId = Number(btn.dataset.prop);
  const prop = propiedadesActuales.find(p=>p.id===propId);
  if (!prop) return;
  const q = `Dime detalles de la propiedad "${prop.titulo}" en ${prop.ciudad}.`;
  // if chat already initialized, put question in input
  if (window.__housegur_chat && typeof window.__housegur_chat.sendMessage === 'function') {
    window.__housegur_chat.sendMessage(q);
  } else {
    // fallback: save to session and open chat later
    sessionStorage.setItem('housegur.pendingQuestion', q);
    const chatCont = document.getElementById('globalChatContainer');
    if (chatCont) chatCont.scrollIntoView({behavior:'smooth'});
  }
});

/* --- DOM ready: init UI and chat partial --- */
document.addEventListener('DOMContentLoaded', async () => {
  // Display user info from localStorage
  const usuario_id = localStorage.getItem('usuario_id');
  const nombre = localStorage.getItem('nombre');
  const userBar = document.getElementById('userBar');
  if (userBar) {
    if (usuario_id && nombre) {
      userBar.innerHTML = `Buenos Dias üë§ <strong>${escapeHtml(nombre)}</strong> (ID: ${usuario_id})`;
      console.log('[PROPIEDADES] User loaded from localStorage:', nombre);
    } else {
      userBar.innerHTML = 'üë§ Visitante (sin login)';
      console.log('[PROPIEDADES] No user in localStorage');
    }
  }

  // Add event listener for "Ver mis tokens" button
  const btnMisTokens = document.getElementById('btnMisTokens');
  if (btnMisTokens) {
    btnMisTokens.addEventListener('click', () => {
      const usuario_id = localStorage.getItem('usuario_id');
      if (!usuario_id) {
        alert('‚ö†Ô∏è Por favor inicia sesi√≥n primero');
        window.location.href = 'login.html';
        return;
      }
      console.log('[PROPIEDADES] Navigating to mis-tokens.html');
      window.location.href = 'mis-tokens.html';
    });
  }

  // Fetch properties from API or use mock data
  try {
    console.log('[PROPIEDADES] Fetching properties from API...');
    const props = await getProperties();
    if (Array.isArray(props) && props.length > 0) {
      propiedadesActuales = props;
      console.log('[PROPIEDADES] API properties loaded:', props.length, 'properties');
    } else {
      console.log('[PROPIEDADES] API returned empty or invalid data');
      propiedadesActuales = [];
    }
  } catch (error) {
    console.warn('[PROPIEDADES] Failed to fetch from API:', error);
    propiedadesActuales = [];
  }

  try {
    populateCiudadOptions();
    loadFilters();
    applyFiltersAndRender();
  } catch(e){ console.warn('[PROPIEDADES] init listado failed', e); }

  // cargar partial del chat (fallback si fetch no disponible)
  try {
    const partialUrl = new URL('partials/chat.html', location.href).href;
    const resp = await fetch(partialUrl);
    if (resp.ok) {
      document.getElementById('chatAside').innerHTML = await resp.text();
    } else {
      document.getElementById('chatAside').innerHTML = '<div id="globalChatContainer"></div>';
    }
  } catch(e) {
    document.getElementById('chatAside').innerHTML = '<div id="globalChatContainer"></div>';
  }

  // inicializar chat
  if (typeof initGlobalChat === 'function') {
    // In production rely on stored user info (localStorage); do not read user from URL params.
    const usuario = nombre || 'Invitado';
    // Get chat webhook from centralized config (js/config.js)
    const CHAT_WEBHOOK = window.CONFIG?.CHAT_WEBHOOK || 'https://palasino.app.n8n.cloud/webhook/housegur-chat';
    initGlobalChat('globalChatContainer', { user: usuario, props: propiedadesActuales, webhookUrl: CHAT_WEBHOOK });
    // if there was a pending question set before chat init, send it
    const pendingQ = sessionStorage.getItem('housegur.pendingQuestion');
    if (pendingQ && window.__housegur_chat && typeof window.__housegur_chat.sendMessage === 'function') {
      window.__housegur_chat.sendMessage(pendingQ);
      sessionStorage.removeItem('housegur.pendingQuestion');
    }
  } else {
    console.warn('[PROPIEDADES] initGlobalChat no disponible');
  }
});
</script>
</body>
</html>